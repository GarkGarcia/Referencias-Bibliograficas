#!/usr/bin/ruby

require 'asciidoctor'
require 'json'

OUTPUT = File::open  "index.html", "w"
DOWNL_TXT = "Link de Download"
ANCHOR_OPTS = {:type => :link, :alt => DOWNL_TXT}
NOMES = {
    "MAT" => "Matemática",
    "MAP" => "Matemática Aplicada",
    "MAE" => "Estatística",
    "MAC" => "Computação"
}

class Integer
  ROMAN_NUMBERS = {
    1000 => "M",
     900 => "CM",
     500 => "D",
     400 => "CD",
     100 => "C",
      90 => "XC",
      50 => "L",
      40 => "XL",
      10 => "X",
       9 => "IX",
       5 => "V",
       4 => "IV",
       1 => "I",
  }

  def roman
    n = self
    roman = ""

    ROMAN_NUMBERS.each do |value, letter|
      roman << letter*(n / value)
      n = n % value
    end

    roman
  end
end

class String
    def upcase?
        !self[/[[:lower:]]/]
    end
end

def departamento parent, dep, discs
    sec = Asciidoctor::Section::new parent, 1
    sec.title = "Departamento de #{NOMES[dep]}"
    sec.numbered = false
    sec.id = dep.downcase
    
    discs.sort_by { |d| d["code"] }

    for disc in discs do 
        nome = disc["nome"]
        refs = disc["referencias"]

        sec << (disciplina sec, codigo(dep, disc["codigo"]), nome, refs)
    end

    sec
end

def disciplina parent, codigo, nome, refs
    sec = Asciidoctor::Section::new parent, 2
    sec.title = "#{codigo} - #{nome}"
    sec.numbered = false
    sec.id = codigo.downcase
    
    refs.sort_by { |ref| ref["titulo"] }

    list = Asciidoctor::List::new sec, :ulist
    sec << list

    for ref in refs.sort_by do
        list << (referencia list, ref)
    end

    sec
end

def referencia parent, ref
    ano = ref["ano"]
    autores = ref["autores"]
    src = "#{autores.map { |a| autor a }.join '.; '}. #{titulo ref}. #{ano}"

    item = Asciidoctor::ListItem::new parent, src
    item << (link item, ref)
end

def autor nome 
    nomes = nome.split(/ +/)
    first_names = nomes[0..-2]
        .map {|nome| nome[0, 1]}
        .select(&:upcase?)
        .join '. '
    
    "#{nomes.last.upcase}, #{first_names}"
end

def titulo ref
    output = "_#{ref["titulo"].strip}_"

    if ref["subtitulo"]
        output << ": _#{ref["subtitulo"].strip}_"
    end

    if ref["volume"]
        output << ", _vol. #{ref["volume"].roman}_"
    end

    output
end

def codigo dep, c
    if c.upcase.start_with? dep
        c = c[3..-1]
    end

    dep + c.rjust(4, "0")
end

def link parent, ref
    url = ref["link"]
    txt =  "<strong>#{DOWNL_TXT}</strong>"
    anchor = Asciidoctor::Inline::new parent, :anchor, txt, ANCHOR_OPTS

    if url.start_with? "http"
        anchor.target = url
    else
        anchor.target = "https://#{url}"
    end

    anchor
end

# Carrega a introdução
doc = Asciidoctor::load_file "intro.adoc", {:header_footer => true}

# Carrega os dados a serem adicionados
deps = File::open "referencias.json", "r"
deps = JSON.parse(deps.read)

# Adiciona a informação de cada departamento

deps.sort_by(&:first).each do |dep, discs|
    if discs.length > 0
        doc << (departamento doc, dep, discs)
    end
end

# Salva o site
doc.write doc.convert, OUTPUT

